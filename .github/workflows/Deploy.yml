name: Deploy.yml
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
      - name: Build with Gradle
        run: bash ./gradlew build
      - name: Deploy JAR
        run: |
          $appDir = "$HOME/app"
          if (!(Test-Path $appDir)) {
            New-Item -ItemType Directory -Path $appDir -Force | Out-Null
            Write-Host "Created directory: $appDir"
          }
          
          $jarFile = Get-ChildItem -Path "build/libs" -Filter "*.jar" | Where-Object { $_.Name -notlike "*plain*" } | Select-Object -First 1
          
          if ($null -ne $jarFile) {
            Write-Host "Found JAR: $($jarFile.Name)"
            Write-Host "Stopping existing process..."
            
            $javaProcesses = Get-Process -Name "java" -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like "*home.jar*" }
            if ($null -ne $javaProcesses) {
              $javaProcesses | Stop-Process -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 2
              Write-Host "Process stopped"
            }
            
            Write-Host "Copying JAR: $($jarFile.Name)"
            Copy-Item -Path $jarFile.FullName -Destination "$appDir/home.jar" -Force
            
            Write-Host "Starting application..."
            Start-Process java -ArgumentList "-jar", "$appDir/home.jar"
            Start-Sleep -Seconds 3
            Write-Host "âœ“ Deployment completed!"
          }
          else {
            Write-Error "No JAR file found in build/libs"
            exit 1
          }
        shell: pwsh
